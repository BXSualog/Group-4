    analyzeImage(imageData) {
        // Enhanced image analysis with actual disease detection
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageDataObj.data;
                const width = canvas.width;
                const height = canvas.height;

                // Analysis metrics
                let totalPixels = 0;
                let greenPixels = 0;
                let brownPixels = 0;
                let yellowPixels = 0;
                let blackPixels = 0;
                let whitePixels = 0;

                // Sample every 4th pixel for performance
                const sampleRate = 4;

                for (let y = 0; y < height; y += sampleRate) {
                    for (let x = 0; x < width; x += sampleRate) {
                        const idx = (y * width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];

                        totalPixels++;

                        // Detect green (healthy leaf color)
                        const isGreen = g > r + 15 && g > b + 15 && g > 50 && g < 200;
                        if (isGreen) greenPixels++;

                        // Detect brown spots (fungal/bacterial infection)
                        const isBrown = r > 80 && r < 180 && g > 50 && g < 140 && b < 100 && Math.abs(r - g) < 60;
                        if (isBrown) brownPixels++;

                        // Detect yellow (chlorosis, nutrient deficiency)
                        const isYellow = r > 150 && g > 150 && b < 120 && Math.abs(r - g) < 40;
                        if (isYellow) yellowPixels++;

                        // Detect black/dark spots (severe disease)
                        const isBlack = r < 80 && g < 80 && b < 80;
                        if (isBlack) blackPixels++;

                        // Detect white/pale areas (powdery mildew, bleaching)
                        const isWhite = r > 200 && g > 200 && b > 200;
                        if (isWhite) whitePixels++;
                    }
                }

                // Calculate percentages
                const greenRatio = greenPixels / totalPixels;
                const brownRatio = brownPixels / totalPixels;
                const yellowRatio = yellowPixels / totalPixels;
                const blackRatio = blackPixels / totalPixels;
                const whiteRatio = whitePixels / totalPixels;

                // Disease detection logic
                let condition = "";
                let details = "";
                let confidence = "moderate";
                let recommendations = "";
                let followUp = "";
                let severity = "mild";

                // Calculate disease score
                const diseaseScore = (brownRatio * 100) + (yellowRatio * 80) + (blackRatio * 120) + (whiteRatio * 60);

                // Determine condition based on analysis
                if (brownRatio > 0.08 || blackRatio > 0.05) {
                    // Significant brown or black spots detected
                    condition = "Fungal or Bacterial Leaf Spot Disease";
                    severity = brownRatio > 0.15 || blackRatio > 0.08 ? "high" : "moderate";
                    details = `I've detected significant brown and dark spots covering approximately ${((brownRatio + blackRatio) * 100).toFixed(1)}% of the leaf area. This pattern is consistent with fungal leaf spot disease (such as Cercospora, Septoria, or Anthracnose) or bacterial leaf spot. The spots appear as irregular lesions which can spread rapidly in humid conditions.`;
                    recommendations = "Remove and destroy affected leaves immediately to prevent spread. Apply copper-based fungicide or neem oil every 7-10 days. Improve air circulation around plants. Avoid overhead watering - water at the base only. Isolate infected plants if possible.";
                    followUp = "Are the spots spreading to other leaves? Do they have yellow halos around them?";
                    confidence = "high";
                } else if (yellowRatio > 0.12) {
                    // Significant yellowing detected
                    condition = "Chlorosis / Nutrient Deficiency";
                    severity = "moderate";
                    details = `I've identified significant yellowing affecting approximately ${(yellowRatio * 100).toFixed(1)}% of the leaf. This chlorosis pattern suggests nutrient deficiency (likely nitrogen, iron, or magnesium) or possible overwatering leading to poor nutrient uptake.`;
                    recommendations = "Check soil pH and nutrient levels. Apply balanced fertilizer (NPK 10-10-10) or iron chelate if iron deficiency is suspected. Ensure proper drainage to prevent waterlogging. Test soil moisture before watering.";
                    followUp = "Is the yellowing on older leaves (bottom) or new growth (top)? How often are you watering?";
                    confidence = "moderate";
                } else if (whiteRatio > 0.10) {
                    // White/pale areas detected
                    condition = "Powdery Mildew or Sun Scorch";
                    severity = "moderate";
                    details = `I've detected white or pale areas covering approximately ${(whiteRatio * 100).toFixed(1)}% of the leaf surface. This could indicate powdery mildew (fungal infection) or sun scorch from excessive direct sunlight.`;
                    recommendations = "If powdery: Apply sulfur-based fungicide or baking soda solution (1 tsp per quart water). Improve air circulation. If sun scorch: Move plant to location with filtered light or morning sun only.";
                    followUp = "Is the white area powdery/fuzzy, or is it dry and crispy?";
                    confidence = "moderate";
                } else if (brownRatio > 0.03 && yellowRatio > 0.05) {
                    // Moderate disease indicators
                    condition = "Early Stage Leaf Disease";
                    severity = "mild";
                    details = `I've detected early signs of leaf damage with small brown spots and some yellowing. This appears to be an early-stage infection that can be managed with prompt treatment.`;
                    recommendations = "Monitor closely for spread. Remove any severely affected leaves. Apply preventive fungicide treatment. Ensure good cultural practices (proper watering, air circulation, sunlight).";
                    followUp = "When did you first notice these symptoms? Have they been spreading?";
                    confidence = "moderate";
                } else if (greenRatio > 0.60 && diseaseScore < 5) {
                    // Mostly healthy
                    condition = "Healthy Leaf with Minor Variations";
                    severity = "none";
                    details = `The leaf appears to be in good overall condition with ${(greenRatio * 100).toFixed(1)}% healthy green coloration. Any minor variations detected are within normal range for natural leaf aging or environmental adaptation.`;
                    recommendations = "Continue current care routine. Monitor for any changes. Ensure consistent watering schedule and adequate light exposure. Regular inspection helps catch issues early.";
                    followUp = "Is there a specific concern you have about this plant?";
                    confidence = "high";
                } else {
                    // Mixed or unclear symptoms
                    condition = "Mixed Symptoms Detected";
                    severity = "moderate";
                    details = `I've detected a combination of symptoms including some discoloration and spotting. This could indicate multiple stress factors or early disease development.`;
                    recommendations = "Inspect the plant thoroughly for pests, check soil moisture and drainage, ensure adequate light and air circulation. Consider applying broad-spectrum organic fungicide as a preventive measure.";
                    followUp = "Can you describe the growing conditions? (Light, water frequency, location)";
                    confidence = "moderate";
                }

                // Build response
                const severityEmoji = {
                    "high": "üî¥",
                    "moderate": "üü°",
                    "mild": "üü¢",
                    "none": "‚úÖ"
                };

                let response = `üîç **Image Analysis Complete**\\n\\n`;
                response += `${severityEmoji[severity]} **Condition Detected:** ${condition}\\n\\n`;
                response += `**Confidence Level:** ${confidence}\\n\\n`;
                response += `**Analysis Details:** ${details}\\n\\n`;
                response += `**Recommendations:** ${recommendations}\\n\\n`;
                response += `**Technical Data:**\\n`;
                response += `‚Ä¢ Healthy green: ${(greenRatio * 100).toFixed(1)}%\\n`;
                response += `‚Ä¢ Brown spots: ${(brownRatio * 100).toFixed(1)}%\\n`;
                response += `‚Ä¢ Yellow areas: ${(yellowRatio * 100).toFixed(1)}%\\n`;
                response += `‚Ä¢ Dark spots: ${(blackRatio * 100).toFixed(1)}%\\n\\n`;
                response += followUp;

                resolve(response);
            };

            img.onerror = () => {
                resolve(`‚ùå **Error analyzing image**\\n\\nUnable to process the image. Please ensure it's a valid image file and try again.`);
            };

            img.src = imageData;
        });
    }
