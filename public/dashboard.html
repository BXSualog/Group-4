<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plant Monitoring Dashboard</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="css/dashboard.css" />
  <!-- Leaflet libraries will be loaded dynamically by map.js -->
</head>

<body>
  <script>
    // Emergency Service Worker Unregistration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        if (registrations.length > 0) {
          for (let registration of registrations) {
            registration.unregister().then(() => {
              console.log('[SW] Kill-switch activated. Unregistered.');
              window.location.reload();
            });
          }
        }
      });
      if (window.caches) {
        caches.keys().then(names => {
          for (let name of names) caches.delete(name);
        });
      }
    }
  </script>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="logo">
      <span class="logo-icon">ğŸŒ±</span>
      <span class="logo-text">AgarwoodTrackerPH</span>
    </div>
    <div class="mobile-menu-btn" id="mobileMenuBtn">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="user-profile" id="userProfileTrigger">

      <div class="user-avatar" id="navUserAvatar">?</div>
      <span class="user-name" id="navUserName">Setup Profile</span>

      <!-- Profile Dropdown Menu -->
      <div class="profile-dropdown" id="profileDropdown">
        <div class="dropdown-header">
          <p class="dropdown-label" id="dropdownRoleLabel">Account Menu</p>
        </div>
        <div class="dropdown-items">
          <button class="dropdown-item" id="btnStewardship">
            <span class="item-icon">ğŸŒ³</span>
            <span>Stewardship's Grove</span>
          </button>
          <button class="dropdown-item" id="btnNotifications">
            <span class="item-icon">ğŸ””</span>
            <span>Notifications</span>
            <span id="notifBadge" class="notification-badge-dot" style="display: none;"></span>
          </button>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item logout" id="btnLogout">
            <span class="item-icon">ğŸšª</span>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <ul class="sidebar-menu">
        <li>
          <a href="#" class="menu-item active" data-page="dashboard">
            <span class="icon">ğŸ“Š</span>
            <span class="menu-text">Home</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-item" data-page="plants">
            <span class="icon">ğŸŒ¿</span>
            <span class="menu-text">My Plants</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-item" data-page="map">
            <span class="icon">ğŸ—ºï¸</span>
            <span class="menu-text">Farm Map</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-item" data-page="messages">
            <span class="icon">ğŸ’¬</span>
            <span class="menu-text">Messages</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-item" data-page="stewards">
            <span class="icon">ğŸ•µï¸</span>
            <span class="menu-text">Stewards</span>
          </a>
        </li>
      </ul>
    </aside>

    <!-- Content Area -->
    <main class="content">
      <div class="content-top">
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <span id="crumbs">Home</span>
        </nav>
      </div>
      <div id="globalAlertBanner" class="global-alert-banner" style="display: none;">
        <span class="alert-icon">âš ï¸</span>
        <span id="alertBannerText" class="alert-text"></span>
        <button class="close-alert" id="closeAlertBanner">&times;</button>
      </div>

      <!-- Stewards Content -->
      <div id="stewardsContent" class="content-section">
        <div class="page-header">
          <h2>Find a Steward</h2>
          <p>Discover professional caretakers for your plants</p>
        </div>
        <div class="toolbar">
          <input id="stewardSearch" class="input" type="search" placeholder="Search stewards by name or specialty..."
            autocomplete="off" />
        </div>
        <div id="stewardsList" class="stewards-grid">
          <!-- Loaded by JS -->
          <div class="empty-state">Loading stewards...</div>
        </div>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboardContent" class="content-section active">
        <div class="page-header">
          <h2>Home</h2>
          <p>Overview of your plant investments</p>
        </div>

        <!-- Weather Widget -->
        <div class="weather-widget" id="weatherWidget">
          <!-- Injected by JS -->
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">ğŸŒ±</div>
            <div class="stat-info">
              <h3 id="statTotal">-</h3>
              <p>Total Plants</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-info">
              <h3 id="statHealthy">-</h3>
              <p>Healthy</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸŒ¿</div>
            <div class="stat-info">
              <h3 id="statGrowing">-</h3>
              <p>Growing</p>
            </div>
          </div>
        </div>

        <h3 class="section-title">Recent Plants</h3>
        <div class="plants-grid" id="plantsGrid"></div>
      </div>

      <!-- My Plants Content -->
      <div id="plantsContent" class="content-section">
        <div class="page-header">
          <h2>My Plants</h2>
          <p>View and manage all your plant investments</p>
        </div>
        <div class="toolbar">
          <input id="plantSearch" class="input" type="search" placeholder="Search plants (name, location, status)..."
            autocomplete="off" />
          <select id="plantSort" class="select" aria-label="Sort plants">
            <option value="name-asc">Sort: Name (Aâ†’Z)</option>
            <option value="name-desc">Sort: Name (Zâ†’A)</option>
            <option value="height-desc">Sort: Height (Highâ†’Low)</option>
            <option value="height-asc">Sort: Height (Lowâ†’High)</option>
          </select>
        </div>
        <div class="chips" role="group" aria-label="Filters">
          <button class="chip active" type="button" data-filter="all">
            All
          </button>
          <button class="chip" type="button" data-filter="healthy">
            Healthy
          </button>
          <button class="chip" type="button" data-filter="growing">
            Growing
          </button>
          <button class="chip" type="button" data-filter="attention">
            Attention
          </button>
          <button class="chip chip-ghost" type="button" id="clearPlantFilters">
            Clear
          </button>
        </div>
        <div id="plantsEmpty" class="empty" style="display: none">
          <h3>No plants found</h3>
          <p>Try clearing search/filters.</p>
          <button class="btn" type="button" id="clearPlantsBtn">Clear</button>
        </div>
        <div id="plantsSkeleton" class="skeleton-grid" aria-hidden="true"></div>
        <div class="plants-grid" id="allPlantsGrid"></div>
      </div>

      <!-- Map Content -->
      <div id="mapContent" class="content-section">
        <div class="page-header">
          <h2>Farm Map</h2>
          <p>Interactive zone visualization</p>
        </div>

        <!-- Map Controls -->
        <div class="map-controls-bar">
          <div class="map-control-group">
            <label>ğŸ—ºï¸ Map Type:</label>
            <select id="mapTypeSelector" class="select">
              <option value="street">Street</option>
              <option value="satellite">Satellite</option>
            </select>
          </div>

          <div class="map-control-group">
            <label>ğŸŒ± Filter Plants:</label>
            <button class="chip active" data-plant-filter="all">All</button>
            <button class="chip" data-plant-filter="healthy">Healthy</button>
            <button class="chip" data-plant-filter="growing">Growing</button>
            <button class="chip" data-plant-filter="attention">Attention</button>
          </div>

          <div class="map-control-group">
            <label>ğŸ”§ Tools:</label>
            <button class="btn btn-sm" id="toggleDrawing">âœï¸ Draw</button>
            <button class="btn btn-sm" id="toggleHeatmap">ğŸŒ¡ï¸ Heatmap</button>
            <button class="btn btn-sm" id="toggleClustering">ğŸ“ Cluster</button>
          </div>
        </div>

        <div class="map-layout">
          <div class="map-container" id="farmMap">
            <!-- Map rendered here -->
          </div>

          <!-- Analytics Sidebar -->
          <div class="map-analytics-panel" id="analyticsPanel" style="display: none;">
            <div class="analytics-header">
              <h3>Zone Analytics</h3>
              <button class="close-btn" id="closeAnalytics">Ã—</button>
            </div>
            <div id="analyticsContent" class="analytics-content">
              <p>Click a zone to view details</p>
            </div>
          </div>
        </div>

        <div class="map-legend">
          <span class="legend-item" data-status="healthy"><span class="dot good"></span> Good</span>
          <span class="legend-item" data-status="growing"><span class="dot warning"></span> Warning</span>
          <span class="legend-item" data-status="attention"><span class="dot alert"></span> Alert</span>
        </div>
      </div>

      <!-- Plant Details Content -->
      <div id="plantDetailsContent" class="content-section">
        <button class="back-btn" id="backToPlants">â† Back to Plants</button>
        <div id="plantDetailsContainer"></div>
      </div>

      <!-- Messages Content -->
      <div id="messagesContent" class="content-section">
        <div class="page-header">
          <h2>Messages</h2>
          <p>Communicate with farmers, experts, and investors</p>
        </div>

        <div class="messaging-container">
          <div class="contacts-panel">
            <div class="contacts-header">
              <h3>
                Contacts <span id="unreadTotal" class="pill-inline"></span>
              </h3>
            </div>
            <div class="contacts-search">
              <input id="contactSearch" class="input" type="search" placeholder="Search contacts..."
                autocomplete="off" />
            </div>
            <div class="contacts-list" id="contactsList"></div>
          </div>

          <div class="chat-panel">
            <div class="chat-mobile-back" id="chatMobileBack">
              <button class="btn-link" type="button">â† Contacts</button>
            </div>
            <div class="chat-header" id="chatHeader">
              <div class="empty-state-message">
                Select a contact to start messaging
              </div>
            </div>
            <div class="messages-area" id="messagesArea">
              <div class="empty-state-message">No messages yet</div>
            </div>
            <div class="typing" id="typingIndicator" style="display: none">
              Typingâ€¦
            </div>
            <div class="message-input-area" id="messageInputArea" style="display: none">
              <input type="text" id="messageInput" placeholder="Type a message..." />
              <button id="sendBtn" class="send-btn">Send</button>
            </div>
          </div>
        </div>
      </div>


    </main>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <img id="modalImage" src="" alt="Plant Image" />
    </div>
  </div>

  <!-- Notifications Modal -->
  <div id="notificationsModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content notification-modal-content">
      <div class="modal-header">
        <h3><span class="icon">ğŸ””</span> Notifications</h3>
        <span class="close-modal" id="closeNotifications">&times;</span>
      </div>
      <div class="modal-body" id="notificationsList">
        <!-- Injected by JS -->
        <div class="empty-state">
          <p>No new notifications</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Setup Modal -->
  <div id="profileSetupModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="padding: 32px; border-radius: 16px;">
      <div class="modal-header" style="margin-bottom: 20px;">
        <h2 style="color: var(--primary); margin: 0;">ğŸŒ± Set Up Your Profile</h2>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); line-height: 1.6;">Welcome to AgarwoodTrackerPH! Please enter your name
          to complete your profile setup.</p>
        <div class="form-group" style="margin-top: 24px;">
          <label for="setupUsername" style="font-weight: 600; margin-bottom: 8px; display: block;">Full Name</label>
          <input type="text" id="setupUsername" class="input" placeholder="e.g. Juan Dela Cruz" style="width: 100%;" />
        </div>
        <div style="margin-top: 32px; display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn btn-primary" id="btnSaveProfile"
            style="width: 100%; justify-content: center; padding: 14px;">Save Profile</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastHost" class="toast-host" aria-live="polite"></div>



  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="js/data.js"></script>
  <script type="module" src="js/config.js"></script>
  <script type="module" src="js/auth-interceptor.js"></script>
  <script type="module" src="js/dashboard.js?v=5"></script>
</body>

</html>